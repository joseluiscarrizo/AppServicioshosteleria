name: Auto-Rebase Stale Branches

on:
  schedule:
    - cron: '0 3 * * *'  # Every day at 3 AM
  workflow_dispatch:

jobs:
  rebase-stale:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "Copilot Bot"
          git config --global user.email "copilot@github.com"

      - name: Find stale branches
        id: find_stale
        uses: actions/github-script@v6
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const staleBranches = [];

            for (const pr of prs) {
              const updatedAt = new Date(pr.updated_at);
              const daysSinceUpdate = (Date.now() - updatedAt.getTime()) / (1000 * 60 * 60 * 24);

              // PR hasn't been updated in 7+ days
              if (daysSinceUpdate > 7) {
                staleBranches.push({
                  number: pr.number,
                  branch: pr.head.ref,
                  base: pr.base.ref,
                  daysSinceUpdate: daysSinceUpdate.toFixed(1)
                });
              }
            }

            core.setOutput('stale_branches', JSON.stringify(staleBranches));
            console.log(`‚ö†Ô∏è  Found ${staleBranches.length} stale branches`);

            return staleBranches;

      - name: Create rebase PRs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const staleBranches = JSON.parse('${{ steps.find_stale.outputs.stale_branches }}');

            for (const branch of staleBranches) {
              try {
                const rebaseBranch = `repair/rebase-pr-${branch.number}`;

                // Check if rebase PR already exists
                try {
                  await github.rest.git.getRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: `heads/${rebaseBranch}`
                  });
                  console.log(`‚è≠Ô∏è  Rebase PR already exists for #${branch.number}`);
                  continue;
                } catch (e) {
                  // Continue
                }

                // Create rebase repair PR
                const { data: baseBranch } = await github.rest.git.getRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${branch.base}`
                });

                await github.rest.git.createRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `refs/heads/${rebaseBranch}`,
                  sha: baseBranch.object.sha
                });

                console.log(`‚úÖ Created rebase branch: ${rebaseBranch}`);

                // Create rebase PR
                const { data: rebasePR } = await github.rest.pulls.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üîÑ Auto-Rebase: Update stale branch for PR #${branch.number}`,
                  head: rebaseBranch,
                  base: branch.base,
                  body: `## Auto-Generated Rebase PR

This PR automatically rebases the stale branch from **PR #${branch.number}** onto the latest \`${branch.base}\`.

### Details
- **Branch:** \`${branch.branch}\`
- **Base:** \`${branch.base}\`
- **Days since last update:** ${branch.daysSinceUpdate}

### What this PR does
1. Creates a fresh branch from the latest \`${branch.base}\`
2. Keeps the PR branch synchronized with the base branch
3. Resolves any potential conflicts proactively

### Action Required
Review the changes and verify they're correct before merging.

---
*Auto-generated by Copilot Repair Bot* ü§ñ`
                });

                console.log(`‚úÖ Created rebase PR #${rebasePR.number} for stale PR #${branch.number}`);

              } catch (error) {
                console.log(`‚ùå Error rebasing PR #${branch.number}: ${error.message}`);
              }
            }
