name: Repair Status Report

on:
  schedule:
    - cron: '0 9 * * *'  # Every day at 9 AM
  workflow_dispatch:

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - uses: actions/checkout@v3

      - name: Generate repair status report
        uses: actions/github-script@v6
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            let stats = {
              total: prs.length,
              with_conflicts: 0,
              stale: 0,
              failing_tests: 0,
              repair_prs: 0
            };

            const conflictedPRs = [];
            const stalePRs = [];
            const repairPRs = [];

            for (const pr of prs) {
              // Check for conflicts
              if (pr.mergeable === false) {
                stats.with_conflicts++;
                conflictedPRs.push(`#${pr.number}: ${pr.title}`);
              }

              // Check for stale PRs
              const updatedAt = new Date(pr.updated_at);
              const daysSinceUpdate = (Date.now() - updatedAt.getTime()) / (1000 * 60 * 60 * 24);
              if (daysSinceUpdate > 7) {
                stats.stale++;
                stalePRs.push(`#${pr.number}: ${pr.title} (${daysSinceUpdate.toFixed(0)} days)`);
              }

              // Check for repair PRs
              if (pr.title.includes('repair') || pr.title.includes('ðŸ”§')) {
                stats.repair_prs++;
                repairPRs.push(`#${pr.number}: ${pr.title}`);
              }
            }

            const report = `
# ðŸ”§ PR Repair Status Report

**Generated:** ${new Date().toISOString()}

## Summary
- **Total Open PRs:** ${stats.total}
- **PRs with Conflicts:** ${stats.with_conflicts}
- **Stale PRs (>7 days):** ${stats.stale}
- **Active Repair PRs:** ${stats.repair_prs}

## PRs Needing Repair
${conflictedPRs.length > 0 ? '### Merge Conflicts\n' + conflictedPRs.map(p => '- ' + p).join('\n') : 'âœ… No conflicts'}

${stalePRs.length > 0 ? '### Stale Branches\n' + stalePRs.map(p => '- ' + p).join('\n') : 'âœ… No stale branches'}

## Active Repairs
${repairPRs.length > 0 ? repairPRs.map(p => '- ' + p).join('\n') : 'âœ… No active repairs'}

---
*Auto-generated by Copilot Repair Bot* ðŸ¤–
            `;

            console.log(report);
