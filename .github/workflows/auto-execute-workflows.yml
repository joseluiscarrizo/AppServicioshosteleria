name: Auto-Execute Pending Workflows

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes
  workflow_dispatch:

jobs:
  auto-execute:
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - uses: actions/checkout@v3

      - name: Find pending workflow approvals
        id: find_pending
        uses: actions/github-script@v6
        with:
          script: |
            const { data: workflows } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const pendingWorkflows = [];

            for (const workflow of workflows.workflows) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: workflow.id,
                status: 'waiting',
                per_page: 10
              });

              for (const run of runs.workflow_runs) {
                pendingWorkflows.push({
                  id: run.id,
                  name: workflow.name,
                  branch: run.head_branch,
                  created_at: run.created_at
                });
              }
            }

            core.setOutput('pending_workflows', JSON.stringify(pendingWorkflows));
            console.log(`Found ${pendingWorkflows.length} pending workflows`);

            return pendingWorkflows;

      - name: Approve and execute workflows
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pendingWorkflows = JSON.parse('${{ steps.find_pending.outputs.pending_workflows }}');

            for (const workflow of pendingWorkflows) {
              try {
                // Approve workflow run
                await github.rest.actions.approveWorkflowRun({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  run_id: workflow.id
                });

                console.log(`✅ Approved workflow: ${workflow.name} (Run #${workflow.id})`);
              } catch (error) {
                console.log(`❌ Failed to approve workflow ${workflow.name}: ${error.message}`);
              }
            }
