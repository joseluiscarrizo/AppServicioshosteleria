name: Archive Old Workflow Runs

on:
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      failure_retention_days:
        description: 'Days to retain failed runs (default: 30)'
        required: false
        default: '30'
      success_retention_days:
        description: 'Days to retain successful runs (default: 90)'
        required: false
        default: '90'
      dry_run:
        description: 'Dry run â€” report only, do not delete (true/false)'
        required: false
        default: 'false'

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    steps:
      - name: Delete old workflow runs according to retention policy
        uses: actions/github-script@v7
        with:
          script: |
            const FAILURE_RETENTION_DAYS = parseInt(
              context.payload.inputs?.failure_retention_days ?? '30'
            );
            const SUCCESS_RETENTION_DAYS = parseInt(
              context.payload.inputs?.success_retention_days ?? '90'
            );
            const DRY_RUN = (context.payload.inputs?.dry_run ?? 'false') === 'true';

            const now = Date.now();
            const msPerDay = 1000 * 60 * 60 * 24;

            console.log(`=== Archive Old Workflow Runs ===`);
            console.log(`Failure retention: ${FAILURE_RETENTION_DAYS} days`);
            console.log(`Success retention: ${SUCCESS_RETENTION_DAYS} days`);
            console.log(`Dry run:           ${DRY_RUN}`);
            console.log(`Run date:          ${new Date().toISOString()}`);
            console.log('================================\n');

            const { data: workflowsData } = await github.rest.actions.listRepoWorkflows({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            let totalDeleted = 0;
            let totalSkipped = 0;
            let totalErrors = 0;

            for (const workflow of workflowsData.workflows) {
              let page = 1;
              let hasMore = true;

              while (hasMore) {
                const { data: runsData } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflow.id,
                  per_page: 100,
                  page
                });

                if (runsData.workflow_runs.length === 0) {
                  hasMore = false;
                  break;
                }

                for (const run of runsData.workflow_runs) {
                  if (run.status !== 'completed') {
                    totalSkipped++;
                    continue;
                  }

                  const ageMs = now - new Date(run.created_at).getTime();
                  const ageDays = ageMs / msPerDay;

                  const isFailure = ['failure', 'cancelled', 'timed_out', 'startup_failure'].includes(run.conclusion);
                  const retentionDays = isFailure ? FAILURE_RETENTION_DAYS : SUCCESS_RETENTION_DAYS;

                  if (ageDays <= retentionDays) {
                    totalSkipped++;
                    continue;
                  }

                  if (DRY_RUN) {
                    console.log(`[DRY RUN] Would delete: ${workflow.name} run #${run.id} (${run.conclusion}, ${Math.floor(ageDays)}d old)`);
                    totalDeleted++;
                    continue;
                  }

                  try {
                    await github.rest.actions.deleteWorkflowRun({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      run_id: run.id
                    });
                    totalDeleted++;
                    console.log(`Deleted: ${workflow.name} run #${run.id} (${run.conclusion}, ${Math.floor(ageDays)}d old)`);
                  } catch (e) {
                    totalErrors++;
                    console.warn(`Error deleting run #${run.id}: ${e.message}`);
                  }
                }

                // Stop paginating if this page had fewer than 100 results
                hasMore = runsData.workflow_runs.length === 100;
                page++;
              }
            }

            console.log(`\n=== Archive Summary ===`);
            console.log(`Deleted:  ${totalDeleted}`);
            console.log(`Skipped:  ${totalSkipped}`);
            console.log(`Errors:   ${totalErrors}`);
            console.log(`======================`);
