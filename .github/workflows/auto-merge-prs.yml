name: Auto-Merge Ready PRs

on:
  schedule:
    - cron: '0 * * * *'  # Every hour
  workflow_dispatch:
  pull_request_review:
    types: [submitted]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
      checks: read
    steps:
      - uses: actions/checkout@v3

      - name: Auto-merge ready PRs
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            let mergedCount = 0;

            for (const pr of prs) {
              // Check if approved
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const approvals = reviews.filter(r => r.state === 'APPROVED');
              if (approvals.length === 0) continue;

              // Check if all checks passed
              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              const failedChecks = checks.check_runs.filter(
                c => c.status === 'completed' && (c.conclusion === 'failure' || c.conclusion === 'action_required')
              );

              if (failedChecks.length > 0) {
                console.log(`⏭️  PR #${pr.number}: Has failed checks, skipping`);
                continue;
              }

              // Merge PR
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: `Merge PR #${pr.number}: ${pr.title}`,
                  commit_message: `Auto-merged by Copilot Bot\n\n${pr.body || ''}`
                });

                console.log(`✅ Merged PR #${pr.number}: ${pr.title}`);
                mergedCount++;
              } catch (error) {
                console.log(`❌ Failed to merge PR #${pr.number}: ${error.message}`);
              }
            }

            console.log(`\n✅ Total PRs merged: ${mergedCount}`);
