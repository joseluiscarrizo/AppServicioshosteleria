name: Auto Approve Workflow Runs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

jobs:
  approve-workflows:
    runs-on: ubuntu-latest
    permissions:
      actions: write

    steps:
      - name: Approve pending workflow runs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const APPROVAL_DELAY_MS = 10000;
            const { owner, repo } = context.repo;
            const pr = context.payload.pull_request;
            const headSha = pr.head.sha;
            const prAuthor = pr.user.login;

            // Only auto-approve runs from known collaborators to prevent
            // arbitrary code execution from untrusted fork contributors.
            let isCollaborator = false;
            try {
              await github.rest.repos.checkCollaborator({
                owner,
                repo,
                username: prAuthor,
              });
              isCollaborator = true;
            } catch {
              isCollaborator = false;
            }

            if (!isCollaborator) {
              console.log(
                `Skipping auto-approval: '${prAuthor}' is not a repository collaborator.`
              );
              return;
            }

            // Wait briefly to allow other workflow runs to register as "waiting"
            await new Promise(resolve => setTimeout(resolve, APPROVAL_DELAY_MS));

            const { data: { workflow_runs: runs } } =
              await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                status: 'waiting',
                head_sha: headSha,
              });

            if (runs.length === 0) {
              console.log('No workflow runs awaiting approval for this commit.');
              return;
            }

            for (const run of runs) {
              await github.rest.actions.approveWorkflowRun({
                owner,
                repo,
                run_id: run.id,
              });
              console.log(`Approved workflow run #${run.id} (${run.name})`);
            }
