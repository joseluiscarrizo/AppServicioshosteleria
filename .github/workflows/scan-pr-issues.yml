name: Scan PR Issues

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  scan-prs:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            console.log(`Scanning ${prs.length} open PRs...`);
            const now = new Date();

            for (const pr of prs) {
              const issues = [];

              const { data: detail } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              if (detail.mergeable_state === 'dirty') {
                issues.push('conflict');
              }

              const daysSince = Math.floor((now - new Date(pr.updated_at)) / (1000 * 60 * 60 * 24));
              if (daysSince > 7) {
                issues.push('stale');
              }

              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              if (checkRuns.check_runs.some(c => c.conclusion === 'failure')) {
                issues.push('failing-tests');
              }

              if (issues.length > 0) {
                const labels = issues;
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels
                }).catch(() => {});
                console.log(`PR #${pr.number}: issues detected - ${issues.join(', ')}`);
              } else {
                console.log(`PR #${pr.number}: healthy`);
              }
            }
