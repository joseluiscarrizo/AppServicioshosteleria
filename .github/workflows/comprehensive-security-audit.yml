name: Comprehensive Security Audit & Vulnerability Scan

on:
  schedule:
    - cron: '0 1 * * *'  # Daily at 1 AM
  workflow_dispatch:
  push:
    branches: [main, develop]

jobs:
  security-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        id: npm_audit
        continue-on-error: true
        run: |
          npm audit --json > npm-audit-report.json || true
          npm audit --audit-level=high

      - name: Run SAST (SonarQube/CodeQL)
        id: sast
        continue-on-error: true
        run: |
          npm run lint -- --format json > lint-report.json || true
          npm run security:scan || true

      - name: Check for hardcoded secrets
        id: secrets
        continue-on-error: true
        run: |
          sudo apt-get install -y git-secrets || true
          git secrets --install || true
          git secrets --scan || true

      - name: Run dependency-check
        id: depcheck
        continue-on-error: true
        run: |
          npm install -g snyk
          snyk test --json > snyk-report.json || true

      - name: Analyze package vulnerabilities
        uses: actions/github-script@v6
        id: analyze_vulnerabilities
        with:
          script: |
            const fs = require('fs');

            const vulnerabilities = {
              critical: [],
              high: [],
              medium: [],
              low: []
            };

            // Parse npm audit report
            try {
              const auditReport = JSON.parse(fs.readFileSync('npm-audit-report.json', 'utf8'));
              const metadata = auditReport.metadata || {};

              if (auditReport.vulnerabilities) {
                for (const [pkg, vuln] of Object.entries(auditReport.vulnerabilities)) {
                  const severity = vuln.severity || 'unknown';
                  vulnerabilities[severity]?.push({
                    package: pkg,
                    severity: severity,
                    via: vuln.via,
                    title: Array.isArray(vuln.via) ? vuln.via[0]?.title : vuln.via
                  });
                }
              }
            } catch (e) {
              console.log('Could not parse npm audit report');
            }

            core.setOutput('vulnerabilities', JSON.stringify(vulnerabilities));
            return vulnerabilities;

      - name: Generate security report
        uses: actions/github-script@v6
        with:
          script: |
            const vuln = JSON.parse('${{ steps.analyze_vulnerabilities.outputs.vulnerabilities }}');

            const report = `
# ðŸ”’ Comprehensive Security Audit Report

**Timestamp:** ${new Date().toISOString()}
**Scan Type:** Full Security Audit

## Vulnerability Summary

### ðŸ”´ Critical
Count: ${vuln.critical?.length || 0}
${vuln.critical?.length > 0 ? vuln.critical.map(v => `- **${v.package}**: ${v.title}`).join('\n') : 'None'}

### ðŸŸ  High
Count: ${vuln.high?.length || 0}
${vuln.high?.length > 0 ? vuln.high.map(v => `- **${v.package}**: ${v.title}`).join('\n') : 'None'}

### ðŸŸ¡ Medium
Count: ${vuln.medium?.length || 0}

### ðŸ”µ Low
Count: ${vuln.low?.length || 0}

## Remediation Status
- Critical: Action required immediately
- High: Fix within 48 hours
- Medium: Fix within 1 week
- Low: Fix within 1 month

## Automated Actions
- Auto-created: vulnerability-fix-* PRs
- Auto-approval: When tests pass
- Auto-merge: Critical fixes only
            `;

            console.log(report);
