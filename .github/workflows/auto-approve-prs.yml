name: Auto Approve PRs

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    # Only run for non-draft PRs opened by Copilot or automated branches
    if: |
      github.event.pull_request.draft == false &&
      (
        github.actor == 'copilot-swe-agent[bot]' ||
        github.actor == 'github-actions[bot]' ||
        startsWith(github.head_ref, 'copilot/') ||
        startsWith(github.head_ref, 'automated/') ||
        startsWith(github.head_ref, 'bot/')
      )
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Auto approve PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const actor = context.actor;
            const branch = context.payload.pull_request.head.ref;
            const timestamp = new Date().toISOString();

            core.info(`üîç Evaluating auto-approval for PR #${prNumber} from branch '${branch}' by actor '${actor}'`);

            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body:
                  `‚úÖ **Auto-Approved by GitHub Actions Bot**\n\n` +
                  `| Field | Value |\n|---|---|\n` +
                  `| Actor | \`${actor}\` |\n` +
                  `| Branch | \`${branch}\` |\n` +
                  `| Approved at | \`${timestamp}\` |\n` +
                  `| Workflow | Auto Approve PRs |\n\n` +
                  `> ‚ö†Ô∏è This is an automated approval. Merge will proceed once all CI checks pass.`
              });

              core.info(`‚úÖ PR #${prNumber} auto-approved successfully`);

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body:
                  `ü§ñ **Automation Audit Log**\n\n` +
                  `This PR has been **automatically approved** by the CI/CD automation system.\n\n` +
                  `| Field | Value |\n|---|---|\n` +
                  `| Actor | \`${actor}\` |\n` +
                  `| Branch | \`${branch}\` |\n` +
                  `| Approved at | \`${timestamp}\` |\n` +
                  `| Workflow | Auto Approve PRs |\n\n` +
                  `The PR will be merged automatically once all CI checks pass. ‚úÖ`
              });
            } catch (error) {
              core.warning(`‚ö†Ô∏è Could not auto-approve PR #${prNumber}: ${error.message}`);

              try {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body:
                    `‚ö†Ô∏è **Auto-Approval Failed**\n\n` +
                    `Could not automatically approve this PR:\n\`\`\`\n${error.message}\n\`\`\`\n\n` +
                    `Manual approval may be required before the PR can be merged.`
                });
              } catch (commentError) {
                core.warning(`Could not post failure comment: ${commentError.message}`);
              }

              core.setFailed(`Auto-approval failed: ${error.message}`);
            }
