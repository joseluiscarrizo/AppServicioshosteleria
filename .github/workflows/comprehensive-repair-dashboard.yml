name: Comprehensive Repair & Status Dashboard

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9 AM
  workflow_dispatch:

jobs:
  dashboard:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      checks: read
    steps:
      - uses: actions/checkout@v3

      - name: Generate comprehensive dashboard
        uses: actions/github-script@v6
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const stats = {
              total: prs.length,
              conflicts: 0,
              failing_tests: 0,
              stale: 0,
              outdated: 0,
              repair_prs: 0,
              improvement_prs: 0,
              ready_to_merge: 0
            };

            const details = {
              conflicts: [],
              failing: [],
              stale: [],
              repairs: [],
              ready: []
            };

            for (const pr of prs) {
              // Count statistics
              if (pr.mergeable === false) stats.conflicts++;

              const updatedAt = new Date(pr.updated_at);
              const daysSince = (Date.now() - updatedAt.getTime()) / (1000 * 60 * 60 * 24);
              if (daysSince > 7) stats.stale++;

              if (pr.title.includes('repair') || pr.title.includes('REPAIR')) {
                stats.repair_prs++;
              }

              if (pr.title.includes('improvement') || pr.title.includes('IMPROVEMENT')) {
                stats.improvement_prs++;
              }

              // Check if ready to merge
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const approved = reviews.filter(r => r.state === 'APPROVED').length > 0;

              const { data: checks } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });

              const allPassed = checks.check_runs.every(
                c => c.status !== 'completed' || c.conclusion === 'success'
              );

              if (approved && allPassed && pr.mergeable !== false) {
                stats.ready_to_merge++;
                details.ready.push(`#${pr.number}: ${pr.title}`);
              }
            }

            const report = `
# ðŸ¤– Comprehensive PR Repair & Status Dashboard

**Generated:** ${new Date().toISOString()}

## ðŸ“Š Overall Statistics
- **Total Open PRs:** ${stats.total}
- **Ready to Merge:** ${stats.ready_to_merge} âœ…
- **Repair PRs Active:** ${stats.repair_prs} ðŸ”§
- **Improvement PRs:** ${stats.improvement_prs} âœ¨

## âš ï¸ Issues Requiring Attention
- **Merge Conflicts:** ${stats.conflicts}
- **Failing Tests:** ${stats.failing_tests}
- **Stale Branches:** ${stats.stale}

## ðŸš€ Ready for Consolidation
${stats.ready_to_merge > 0 ? details.ready.map(p => '- ' + p).join('\n') : 'None yet'}

## ðŸ”„ Active Repairs
${stats.repair_prs > 0 ? 'Repair PRs are actively working on conflicts and issues' : 'No active repairs'}

## âœ¨ Quality Improvements
${stats.improvement_prs > 0 ? 'Code quality improvements in progress' : 'No active improvements'}

---

### Next Steps
1. Review and merge ready PRs
2. Monitor repair PRs completion
3. Address stale branches
4. Consolidation timeline remains on track

*Dashboard auto-generated by Copilot Status Bot* ðŸ¤–
            `;

            console.log(report);
