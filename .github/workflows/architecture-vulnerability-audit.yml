name: Architecture & Infrastructure Vulnerability Audit

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:

jobs:
  architecture-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Audit Cloud Functions
        id: cloud_functions_audit
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issues = {
              missingAuth: [],
              missingValidation: [],
              missingErrorHandling: [],
              missingLogging: [],
              sqlInjectionRisk: [],
              xssRisk: [],
              hardcodedSecrets: []
            };

            // Scan Cloud Functions directory
            const functionsDir = './functions';
            if (fs.existsSync(functionsDir)) {
              const files = fs.readdirSync(functionsDir).filter(f => f.endsWith('.ts') || f.endsWith('.js'));

              for (const file of files) {
                const content = fs.readFileSync(path.join(functionsDir, file), 'utf8');

                // Check for requiresAuth
                if (!content.includes('requiresAuth') && !content.includes('isAuthenticated')) {
                  issues.missingAuth.push(file);
                }

                // Check for input validation
                if (!content.includes('validate') && !content.includes('schema')) {
                  issues.missingValidation.push(file);
                }

                // Check for error handling
                if (!content.includes('try') && !content.includes('catch')) {
                  issues.missingErrorHandling.push(file);
                }

                // Check for hardcoded secrets
                if (content.match(/password|secret|api_key|token/i) && !content.includes('process.env')) {
                  issues.hardcodedSecrets.push(file);
                }
              }
            }

            core.setOutput('architecture_issues', JSON.stringify(issues));
            return issues;

      - name: Audit API Security
        id: api_audit
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const issues = {
              missingRateLimit: [],
              missingCORS: [],
              missingAuthentication: [],
              exposedPII: [],
              unsafeHTTP: []
            };

            core.setOutput('api_issues', JSON.stringify(issues));
            return issues;

      - name: Generate architecture report
        run: |
          cat << 'EOF' > architecture-audit-report.md
          # Architecture & Infrastructure Audit Report

          ## Cloud Functions Security
          - Auth checks: reviewed
          - Input validation: reviewed
          - Error handling: reviewed

          ## API Security
          - Rate limiting configured: review required
          - CORS properly configured: review required
          - Authentication enforced: review required

          ## Database Security
          - Prepared statements used: review required
          - Access control validated: review required
          - Audit logging enabled: review required

          ## Infrastructure
          - TLS/HTTPS enforced: review required
          - VPC properly configured: review required
          - Backup strategy implemented: review required
          EOF
          cat architecture-audit-report.md
