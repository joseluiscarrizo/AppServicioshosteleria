name: Auto Improve Quality

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  improve-quality:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            console.log(`Quality scan for ${prs.length} open PRs...`);

            for (const pr of prs) {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const largeFiles = files.filter(f => f.changes > 500);
              if (largeFiles.length === 0) continue;

              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number
              });

              const alreadyCommented = comments.some(c => c.body.includes('Quality Improvement System'));
              if (alreadyCommented) continue;

              const fileList = largeFiles.map(f => `- \`${f.filename}\` (${f.changes} changes)`).join('\n');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸ“Š **Quality Improvement System**: This PR contains large files that may benefit from being split:\n${fileList}\n\nConsider breaking this PR into smaller, focused changes.`
              });
              console.log(`Quality tip sent for PR #${pr.number}`);
            }
