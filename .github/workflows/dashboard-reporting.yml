name: Dashboard and Reporting

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

permissions:
  pull-requests: read
  contents: read
  actions: read

jobs:
  generate-dashboard:
    runs-on: ubuntu-latest
    steps:
      - name: Generate PR status dashboard
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const stats = {
              total: pullRequests.length,
              ready: 0,
              conflicted: 0,
              blocked: 0,
              draft: 0,
              behind: 0
            };

            const prDetails = [];

            for (const pr of pullRequests) {
              if (pr.draft) {
                stats.draft++;
                prDetails.push({ number: pr.number, title: pr.title, state: 'draft' });
                continue;
              }

              const { data: prDetail } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const state = prDetail.mergeable_state || 'unknown';
              if (state === 'clean') stats.ready++;
              else if (state === 'dirty') stats.conflicted++;
              else if (state === 'blocked') stats.blocked++;
              else if (state === 'behind') stats.behind++;

              prDetails.push({ number: pr.number, title: pr.title, state });
            }

            const dashboard = [
              '=== TIERED ACCELERATION DASHBOARD ===',
              `Generated: ${new Date().toISOString()}`,
              '',
              '--- SUMMARY ---',
              `Total open PRs:  ${stats.total}`,
              `Ready to merge:  ${stats.ready}`,
              `Has conflicts:   ${stats.conflicted}`,
              `Blocked:         ${stats.blocked}`,
              `Behind base:     ${stats.behind}`,
              `Draft:           ${stats.draft}`,
              '',
              '--- PR DETAILS ---',
              ...prDetails.map(p => `  #${p.number} [${p.state.toUpperCase()}] ${p.title}`)
            ];

            console.log(dashboard.join('\n'));
            core.setOutput('total_prs', stats.total);
            core.setOutput('ready_prs', stats.ready);

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: actions/github-script@v7
        with:
          script: |
            const webhookUrl = process.env.SLACK_WEBHOOK_URL;
            if (!webhookUrl) {
              console.log('SLACK_WEBHOOK_URL not configured - skipping notification');
              return;
            }

            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            const payload = {
              text: `ðŸ¤– *Tiered Acceleration Status Update*\nâ€¢ Open PRs: ${pullRequests.length}\nâ€¢ Time: ${new Date().toISOString()}\nâ€¢ Repo: ${context.repo.owner}/${context.repo.repo}`
            };

            const https = require('https');
            const url = new URL(webhookUrl);
            const body = JSON.stringify(payload);

            const req = https.request({
              hostname: url.hostname,
              path: url.pathname + url.search,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(body)
              }
            }, (res) => {
              console.log(`Slack notification sent: ${res.statusCode}`);
            });

            req.on('error', (err) => console.log(`Slack error: ${err.message}`));
            req.write(body);
            req.end();
