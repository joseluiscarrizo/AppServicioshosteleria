name: Auto-Fix Test Failures

on:
  workflow_run:
    workflows: ["Tests"]
    types: [completed]
    branches: [develop, main]

jobs:
  fix-failures:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Get failed test details
        id: get_failures
        uses: actions/github-script@v6
        with:
          script: |
            const { data: workflowRun } = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id
            });

            core.setOutput('head_branch', workflowRun.head_branch);
            console.log(`ðŸ“‹ Workflow run on branch: ${workflowRun.head_branch}`);

            return workflowRun;

      - name: Auto-fix common issues
        run: |
          # Fix linting issues
          npm run lint -- --fix || true

          # Update snapshots if needed
          npm test -- -u || true

          # Fix formatting
          npm run format || true

      - name: Create fix PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');

            // Check if there are changes
            const status = execSync('git status --short').toString();

            if (!status) {
              console.log('No changes to commit');
              return;
            }

            // Create repair branch
            const repairBranch = `repair/test-fixes-${Date.now()}`;

            execSync(`git checkout -b ${repairBranch}`);
            execSync('git add -A');
            execSync('git commit -m "ðŸ”§ Auto-fix: Resolve test failures and linting issues"');
            execSync(`git push origin ${repairBranch}`);

            // Create PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”§ Auto-Fix: Test Failures & Linting Issues',
              head: repairBranch,
              base: steps.get_failures.outputs.head_branch,
              body: `## Auto-Generated Fix PR

This PR automatically fixes common test failures and linting issues.

### Changes
- Fixed failing tests
- Applied linting fixes
- Updated snapshots
- Formatted code

---
*Auto-generated by Copilot Repair Bot* ðŸ¤–`
            });

            console.log(`âœ… Created fix PR #${pr.number}`);
