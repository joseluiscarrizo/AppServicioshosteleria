# ADR-002: Gestión de Estados de Carga (Loading States)

**Estado:** Aceptado  
**Fecha:** 2026-02-28  
**Autores:** Equipo de Desarrollo

---

## Contexto

La aplicación tiene múltiples estados de carga asíncronos: autenticación, configuración pública de la app, datos de entidades. Sin una gestión centralizada, es fácil que los spinners queden activos indefinidamente si una petición falla silenciosamente (infinite loading bug).

## Decisión

Implementamos dos mecanismos complementarios:

### 1. `LoadingContext` / `useLoading`
Contexto global que permite a cualquier componente registrar y consultar estados de carga con una clave semántica:

```js
const { setLoading, isLoading, isAnyLoading } = useLoading();
setLoading('pedidos', true);
// ... after fetch
setLoading('pedidos', false);
```

### 2. Timeout de Seguridad en `AuthContext`

La función `checkAppState` incluye un timeout de 15 segundos que garantiza que los estados de carga (`isLoadingPublicSettings`, `isLoadingAuth`) siempre se resuelven, incluso si la red no responde:

```js
const loadingTimeout = setTimeout(() => {
  setIsLoadingPublicSettings(false);
  setIsLoadingAuth(false);
  setAuthError({ type: 'timeout', message: 'La carga tardó demasiado.', retryable: true });
}, 15000);
```

El timeout se cancela (`clearTimeout`) cuando la petición completa exitosamente o falla con un error conocido.

## Consecuencias

**Positivo:**
- Eliminado el riesgo de spinner infinito en el flujo de autenticación.
- `LoadingContext` permite gestionar estados de carga de forma declarativa en toda la app.

**Negativo:**
- El timeout de 15s puede activarse en conexiones lentas legítimas, mostrando un error cuando la petición aún podría resolverse.

## Alternativas Consideradas

- **AbortController + signal:** Cancelar la petición HTTP directamente. Requiere más integración con `createAxiosClient`.
- **React Query (ya en uso):** Para datos de entidades, React Query ya gestiona loading/error de forma robusta. El timeout manual solo es necesario para el flujo de auth inicial que no usa React Query.
